---
title: "S&P 500"
author: "John Yuill"
date: "`Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warning=FALSE)

library(quantmod) ## includes zoo (which includes xts)
library(PerformanceAnalytics)
library(tidyverse)
library(lubridate)
library(scales)
```

## Get S&P 500 data

* Set start date to go back in history earlier than default

```{r}
## tip: set start date mth before you want data so that you will have mthly returns for full period
## (since there is no return calc for the first mth, by def)
sp500 <- getSymbols(Symbols="^GSPC", from="1969-12-01", auto.assign=FALSE)
head(sp500)
```

## Take a look

### Price trends

```{r}
## basic chart_Series from quantmod
chart_Series(Cl(sp500))
```

### Monthly Returns

```{r}
sp500_mth <- to.monthly(sp500)

sp500_mth_ret <- Return.calculate(sp500_mth$sp500.Close)

chart_Series(sp500_mth_ret)
```

## Analyse Monthly Returns

### Summary

```{r}
## drop first mth, which is NA (by def)
sp500_mth_ret <- sp500_mth_ret[-1,]

sp500_mth_ret_ave <- mean.geometric(sp500_mth_ret)

sp500_mth_ret_stdev <- StdDev(sp500_mth_ret) ## StdDev from PerformanceAnalytics
sp500_mth_min <- min(sp500_mth_ret, na.rm=TRUE)
sp500_mth_max <- max(sp500_mth_ret, na.rm=TRUE)


```

Ave mthly return (geometric): `r sp500_mth_ret_ave` <br />
Std dev mthly return: `r sp500_mth_ret_stdev` <br />
Worst mthly return: `r sp500_mth_min` <br />
Best mthly return: `r sp500_mth_max` <br />

### Distribution

```{r}
## convert to data frame for easy manage with tidyverse
df_sp500_mth_ret <- as.data.frame(sp500_mth_ret)
df_sp500_mth_ret$mth <- row.names(df_sp500_mth_ret)
row.names(df_sp500_mth_ret) <- seq(1:nrow(df_sp500_mth_ret))
oe
```

```{r}
df_sp500_mth_ret %>% ggplot(aes(x=sp500.Close))+geom_histogram()+
  geom_vline(xintercept = 0, color='grey')+
  geom_vline(xintercept=sp500_mth_ret_ave[1], color='blue')+
  geom_vline(xintercept=sp500_mth_ret_ave[1]-sp500_mth_ret_stdev[1], color='lightblue')+
  geom_vline(xintercept=sp500_mth_ret_ave[1]+sp500_mth_ret_stdev[1], color='lightblue')+
  geom_vline(xintercept=sp500_mth_ret_ave[1]-(2*sp500_mth_ret_stdev[1]), color='lightblue', linetype='dashed')+
  geom_vline(xintercept=sp500_mth_ret_ave[1]+(2*sp500_mth_ret_stdev[1]), color='lightblue', linetype='dashed' )+
  scale_y_continuous(expand=c(0,0))+
  theme_classic()
```


### Sharpe ratio

* different calc methods with similar but not same results

```{r}
## set risk free rate for comparison
rfrate <- 0.03 ## annual
sp500_yr <- to.yearly(sp500) ## convert daily to annual
sp500_yr_ret <- Return.calculate(sp500_yr[,4]) ## calculate returns based on annual close
## get ave anual return
sp500_yr_ret_ave <- mean.geometric(sp500_yr_ret)
sp500_yr_ret_ave
## get annual return std dev
sp500_yr_ret_sd <- StdDev(sp500_yr_ret)
sp500_yr_ret_sd

## calc sharpe ratio
## on annual data
sh_ratio <- (sp500_yr_ret_ave-rfrate)/sp500_yr_ret_sd
sh_ratio
## annualized based on mthly data using Performance Analytics
table.AnnualizedReturns(sp500_mth_ret, Rf=rfrate/12, scale=12)
## annualized based on daily data
sp500_ret <- Return.calculate(sp500[,4])
table.AnnualizedReturns(sp500_ret, Rf=rfrate/252, scale=252)
```

## Rolling returns

### Annual 12-mth Returns by Each Month

* Chart shows trailing annualized returns for each month

```{r}
## convert daily to monthly again, this time set index to last day of mth
## needed for rolling charts (otherwise index is Jan 1990, Feb 1990, etc)
sp500_mth2 <- to.monthly(sp500, indexAt='lastof')
sp500_mth2_ret <- Return.calculate(sp500_mth2[,4], method='discrete')
sp500_mth2_ret <- sp500_mth2_ret[-1,]

## annualized return over whole period
#sp500_mth2_ann <- Return.annualized(sp500_mth2_ret, scale=12)
## get annualized return by month (for width=12)
sp500_mth2_ann2 <- apply.rolling(sp500_mth2_ret, width=12, by=1, FUN='Return.annualized')

# Plotting the 12-month rolling annualized return from monthly data
chart.RollingPerformance(R = sp500_mth2_ret, width = 12, FUN = "Return.annualized")

```

```{r}
## identify outliers
## define percentiles to use for outliers (could also use std dev)
ret_top <- quantile(sp500_mth2_ann2, 0.95, na.rm=TRUE)
ret_bottom <- quantile(sp500_mth2_ann2, 0.05, na.rm=TRUE)

## filter for outliers defined above
sp500_arTop <- sp500_mth2_ann2[sp500_mth2_ann2[,'calcs']>=ret_top,]
sp500_arBottom <- sp500_mth2_ann2[sp500_mth2_ann2[,'calcs']<=ret_bottom,]

## clean-up data for chart
sp500_tb <- bind_rows(as.data.frame(sp500_arTop), as.data.frame(sp500_arBottom))
sp500_tb$month <- row.names(sp500_tb)
row.names(sp500_tb) <- seq(1:nrow(sp500_tb))
sp500_tb <- sp500_tb %>% rename(
  ann_ret=calcs
) %>% mutate(
  year=year(month)
)

```

```{r}
## chart outliers
sp500_tb %>% ggplot(aes(x=month, y=ann_ret, fill=as.factor(year)))+geom_col()+
  scale_y_continuous(labels=percent)+
  theme_classic()+theme(axis.text.x = element_text(vjust=1, hjust=1, angle=60))
```


```{r}
sp500_mth2_ret2 %>% ggplot(aes(x=sp500.Close))+geom_histogram()
```


## Windows for Specific Date Ranges

```{r}
#sp500 <- sp500_2009
sp500_2008 <- sp500["2008-01-01/2008-12-31"]
chart_Series(sp500_2008$GSPC.Close)

sp500_2019 <- sp500["2019-01-01/2019-12-31"]
chart_Series(sp500_2019$GSPC.Close)
```


```{r}
sp500_ret_2008 <- window(sp500_ret, start="2008-01-01", end="2008-12-31")
sp500_ret_2019 <- window(sp500_ret, start="2019-01-01", end="2019-12-31")

chart_Series(sp500_ret_2008)
chart_Series(sp500_ret_2019)

# Plotting settings
par(mfrow = c(1, 2) , mar=c(3, 2, 2, 2))
names(sp500_ret_2008) <- "sp500_2008"
names(sp500_ret_2019) <- "sp500_2019"

## Histograms from PerformanceAnalytics
# Plot histogram of 2008
chart.Histogram(sp500_ret_2008, methods=c('add.density', 'add.normal'))

# Plot histogram of 2014
chart.Histogram(sp500_ret_2019, methods=c('add.density', 'add.normal'))

```

### Skewness and Kurtosis

* Skewness tells us if the distribution is skewed away from normal; negative skewness indicates longer tail on the negative side (left skew)
* Kurtosis tells us if the tails are fatter than normal curve, indicating higher likelihood of results outside the range (in std dev) than are present in normal distribution; highlights volatility

```{r}
sk2008 <- skewness(sp500_ret_2008)
sk2019 <- skewness(sp500_ret_2019)

krt2008 <- kurtosis(sp500_ret_2008)
krt2019 <- kurtosis(sp500_ret_2019)
```

Skewness: <br />
2008: `r sk2008` <br />
2019: `r sk2019` 

Kurtosis: <br />
2008: `r krt2008` <br />
2019: `r krt2019`