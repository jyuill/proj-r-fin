---
title: "VTI Analysis"
author: "`r Sys.getenv('USER')`"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message=FALSE,
                      warning=FALSE,
                      fig.height=3.5,
                      fig.width=6)

library(tidyverse)
library(lubridate)
library(here)
library(PerformanceAnalytics)
library(plotly)
library(scales)
library(gridExtra)
library(DT)
library(quantmod)
library(dygraphs)
library(forecast)

options(scipen = 10)
theme_set(theme_light())

## chart params
bar_fill <- 'cornflowerblue'
```

## VTI Analysis

Looking at trends, recent status, and expectations for Vanguard VTI ETF.

### Get Data

```{r cars}
getSymbols(c("VTI","^GSPC"), auto.assign=TRUE) ## auto.assign=TRUE saves object; FALSE prints out data

## viz
dygraph(Cl(VTI))
dygraph(Cl(GSPC))
```

VTI tracks S&P 500 very closely.

### Returns

#### Daily Returns

```{r}
VTI_return <- dailyReturn(VTI)
dygraph(VTI_return)

## summary stats
summary(VTI_return)

## distribution
#hist(VTI_return)

## convert to data frame for ggplot
VTI_return_df <- data.frame(VTI_return)
VTI_return_df$date <- row.names(VTI_return_df)

VTI_return_df %>% ggplot(aes(x=daily.returns, label=mean(daily.returns)))+
  geom_histogram(fill=bar_fill)+
  geom_vline(xintercept=mean(VTI_return_df$daily.returns), linetype='dashed')+
  geom_vline(xintercept=quantile(VTI_return_df$daily.returns, 0.25), linetype='dotted')+
  geom_vline(xintercept=quantile(VTI_return_df$daily.returns, 0.75), linetype='dotted')+
  annotate(geom = 'text', 
           label=paste0("mean= ",prettyNum(mean(VTI_return_df$daily.returns)*100, digits=2),"%"), x=mean(VTI_return_df$daily.returns), y=1720, color='blue')+
  annotate(geom='text', label="lower 25%", x=quantile(VTI_return_df$daily.returns, 0.25)-0.02, color='blue', y=1500)+
  annotate(geom='text', label="upper 75%", x=quantile(VTI_return_df$daily.returns, 0.75)+0.02, color='blue', y=1500)+
  scale_y_continuous(labels=comma, expand=expansion(mult=c(0,0.1)))+
  scale_x_continuous(labels=percent)+
  labs(title='Distribution of Daily Returns for VTI')
```
Daily returns very tightly centered around 0. 

What is the effective annual rate based on mean daily rate?

```{r}
i <- mean(VTI_return_df$daily.returns)
fv <- (1+i)^365-1
paste(prettyNum(fv*100, digits=3),"%")
```

### Decompose 

```{r}
vti_dc <- decompose(ts(VTI$VTI.Close, frequency=365), type='additive')
plot(vti_dc)
```

Can see:

* gradual upward trend, acceleratiing in recent periods.
* seasonal pattern within the years: looks like starts high, drops off in early part of year and then climbs back up.

### Trends

```{r}
vti_df <- data.frame(VTI)
vti_df$date <- index(VTI)
```

```{r}
vti_df %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_smooth(method='lm')
```

Linear model based on VTI.Close:

(technically NOT supposed to use linear regression with time series, because violates the autocorrelation rule: residuals should not be correlated.)

```{r}
vti_lm <- lm(formula=VTI.Close~date, data=vti_df)
summary(vti_lm)

# doesn't work - just runs without stop
#vti_tslm <- tslm(formula=VTI.Close~date, data=VTI)
#summary(vti_tslm)
# also doesn't work
#tslm(VTI.Close ~ trend+season, data=VTI)

```

Remove Data 2020 and Beyond

```{r}
vti_df_2020 <- vti_df %>% filter(date<='2019-12-31')
vti_df_2020 %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_smooth(method='lm')
```
```{r}
vti_2020_lm <- lm(formula=VTI.Close~date, data=vti_df_2020)
summary(vti_2020_lm)
```

```{r}
#vti_2021 <- vti_df %>% filter(date>'2019-12-31')
#pvti_2021 <- vti_2021 %>% select(date)
#predict(vti_2020_lm, newdata=pvti_2021)
#pvti_2021$clpred <- predict(vti_2020_lm, newdata=pvti_2021)
#ggplot(pvti_2021, aes(x=date, y=clpred))+geom_line()

## pre-2020 lm to make predictions of close for whole set
pvti <- vti_df %>% select(date)
pvti$clpred <- predict(vti_2020_lm, newdata=pvti)

vti_dfp <- left_join(vti_df, pvti, by='date')
```

Expected trend beyond 2019 based on linear model for pre-2020 period:

```{r}
vti_dfp %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_line(aes(y=clpred))
```

One conclusion could be that VTI is currently over-priced and should be closer to 160 to be in line with historical trends.

Lets extend the prediction out:

* 6 months

```{r}
## pre-2020 lm to make predictions into the future
pvti <- vti_df %>% select(date)
pvti_6m <- data.frame(date=seq.Date(from=Sys.Date(), to=Sys.Date()+180, by='day')) 
pvti <- bind_rows(pvti, pvti_6m)
pvti$clpred6 <- predict(vti_2020_lm, newdata=pvti)

vti_dfp2 <- full_join(vti_df, pvti, by='date')
```

```{r}
vti_dfp2 %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_line(aes(y=clpred6))
```

* 1 yr out

```{r}
## pre-2020 lm to make predictions into the future
pvti <- vti_df %>% select(date)
pvti_1y <- data.frame(date=seq.Date(from=Sys.Date(), to=Sys.Date()+365, by='day')) 
pvti <- bind_rows(pvti, pvti_1y)
pvti$clpred1y <- predict(vti_2020_lm, newdata=pvti)

vti_dfp3 <- full_join(vti_df, pvti, by='date')
```

```{r}
vti_dfp3 %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_line(aes(y=clpred1y))
```

* 5 years out

```{r}
## pre-2020 lm to make predictions into the future
pvti <- vti_df %>% select(date)
pvti_5y <- data.frame(date=seq.Date(from=Sys.Date(), to=Sys.Date()+(365*5), by='day')) 
pvti <- bind_rows(pvti, pvti_5y)
pvti$clpred5y <- predict(vti_2020_lm, newdata=pvti)

vti_dfp5y <- full_join(vti_df, pvti, by='date')
```

```{r}
vti_dfp5y %>% ggplot(aes(x=date, y=VTI.Close))+geom_line()+
  geom_line(aes(y=clpred5y))
```

Suggests a conservative scenario would see us around current levels in 5 yrs or so, if reverted back to expectations based on historical trends.

## Get rolling 1 year returns

```{r}
## roll up to months
end_mth <- endpoints(VTI, on="months")
VTIm <- VTI[end_mth,]

VTIm$yr_rtn <- (VTI$VTI.Close/lag.xts(VTIm$VTI.Close, k=12))-1
#VTImr <- monthlyReturn(VTI$VTI.Close)

```

```{r}
#dygraph(VTIm$VTI.Close)
dygraph(VTIm$yr_rtn)
```

### Summary stats

```{r}
summary(VTIm$yr_rtn)
```

Data frame for more flexibility in analyzing and visualizing data.

```{r}
VTIm_df <- as.data.frame(VTIm)
## convert rownames, which are dates, to a date col
VTIm_df <- rownames_to_column(VTIm_df, var="date")
VTIm_df$date <- date(VTIm_df$date)
## add pos or neg indicators
VTIm_df <- VTIm_df %>% mutate(
  status = ifelse(yr_rtn>0,"pos",ifelse(yr_rtn<0,"neg","neutral"))
)
VTIm_df$status <- factor(VTIm_df$status)
```

```{r}
VTIm_df %>% filter(!is.na(yr_rtn)) %>% 
  ggplot(aes(x=date, y=yr_rtn))+
  ## prefer geom_area but somehow doesn't work with conditional colors
  ## aggravating!
  geom_col(aes(fill=status))+
  scale_fill_manual(values=c("pos"="darkgreen", "neg"="red"))+
  scale_y_continuous(labels=percent_format())+
  labs(title="1 yr rolling returns at end of each mth", x="", y="1 yr return - rolling")
```

### Distribution

```{r}
size_spec <- 1
VTIm_df %>% ggplot(aes(x=yr_rtn))+geom_histogram(fill=bar_fill)+
  geom_vline(xintercept = mean(VTIm_df$yr_rtn, na.rm=TRUE), color='blue', linetype='dotted', size=size_spec)+
  scale_x_continuous(labels=percent_format())+
  geom_vline(xintercept = median(VTIm_df$yr_rtn, na.rm=TRUE), color='green', linetype='dotted', size=size_spec)+
  geom_vline(xintercept = quantile(VTIm_df$yr_rtn, 0.25, na.rm=TRUE), color='red', linetype='dotted', size=size_spec)+
  geom_vline(xintercept=0, size=size_spec, color='black')+
  labs(title="Distribution of Rolling 1 Yr Returns",
       x="Rolling 1 yr return at end of mth", y="",
       caption="lines: red=25th percentile, blue=avg, green=median, black=0")
```

```{r}
#VTIm_df$yr_rtn
VTI_pos <- VTIm_df %>% filter(yr_rtn>0)
VTI_neg <- VTIm_df %>% filter(yr_rtn<0)

pc_pos <- round(nrow(VTI_pos)/nrow(VTIm_df),2)
pc_neg <- round(nrow(VTI_neg)/nrow(VTIm_df),2)

avg_pos <- round(mean(VTI_pos$yr_rtn),2)
avg_neg <- round(mean(VTI_neg$yr_rtn),2)
```

### Odds

* `r pc_pos*100`% chance of positive 1 yr return.
* avg positive 1 yr return: `r avg_pos*100`%
* avg neg 1 yr return: `r avg_neg*100`%